{% extends 'base.html'%}

{% block extra_css %}
<link rel="stylesheet" href="{{ STATIC_URL }}css/upload.css">
<style>
    /* Loading spinner styles */
    .loading-spinner {
        display: inline-block;
        width: 50px;
        height: 50px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: #48bb78;
        animation: spin 1s ease-in-out infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 1000;
    }

    .loading-text {
        margin-top: 10px;
        color: #48bb78;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block title %}Upload Image - AgroVision
{% endblock %}

{% block content %}
<div class="container">
    <h2>Upload an Image for Prediction</h2>

    <form method="POST" enctype="multipart/form-data" id="uploadForm">
        {%csrf_token%}

        <div class="prediction-options">
            <label class="prediction-box">
                <input type="radio" name="prediction_type" value="disease" required>
                <span>Disease Prediction</span>
            </label>

            <label class="prediction-box">
                <input type="radio" name="prediction_type" value="pest" required>
                <span>Pest Prediction</span>
            </label>
        </div>

        <input type="file" name="image" id="imageUpload" required>
        <label for="imageUpload" class="custom-file-upload">Choose File</label>
        <p id="fileName">No file chosen</p>

        <button type="submit">Upload & Predict</button>
    </form>
    
    {% if file_url %}
        <div class="result-container">
            <h3>Uploaded Image:</h3>
            <img id="imagePreview" src="{{ file_url }}" alt="Uploaded Image">

            <h3>Prediction Result:</h3>
            <p><strong>Label: {{label}}</strong></p>
            <p><strong>Confidence: {{ confidence}}</strong></p>
        </div>
        <form action="{% url 'treatment_recommendation' %}" method="GET" id="recommendationForm">
            <input type="hidden" name="prediction_type" value="{{ prediction_type }}">
            <input type="hidden" name="label" value="{{ label }}">
            <input type="hidden" name="image_url" value="{{ file_url }}">
            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">
            <input type="hidden" name="city" id="city">
            <button type="submit" class="ai-recommend-btn">Get AI Recommendations</button>
        </form>
    {% endif %}
</div>

<script>
    function showLoading(message) {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'loading-overlay';
        loadingOverlay.innerHTML = `
            <div class="loading-spinner"></div>
            <div class="loading-text">${message}</div>
        `;
        document.body.appendChild(loadingOverlay);
    }

    function hideLoading() {
        const loadingOverlay = document.querySelector('.loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.remove();
        }
    }

    // Show selected file name
    document.getElementById("imageUpload").addEventListener("change", function(event) {
        const fileName = event.target.files[0] ? event.target.files[0].name : "No file chosen";
        document.getElementById("fileName").textContent = fileName;

        // Preview selected image before upload
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById("imagePreview").src = e.target.result;
        };
        reader.readAsDataURL(event.target.files[0]);
    });

    // Show loading when upload form is submitted
    document.getElementById('uploadForm').addEventListener('submit', function() {
        showLoading('Analyzing your image...');
    });

    // Get user's location when the recommendation form is submitted
    document.getElementById('recommendationForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        showLoading('Getting your location...');
        
        try {
            // Get user's location
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    
                    // Get city name using reverse geocoding
                    try {
                        showLoading('Finding your city...');
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        const city = data.address.city || data.address.town || data.address.village || 'Unknown';
                        
                        // Set the form values
                        document.getElementById('latitude').value = latitude;
                        document.getElementById('longitude').value = longitude;
                        document.getElementById('city').value = city;
                        
                        // Submit the form
                        showLoading('Generating AI recommendations...');
                        e.target.submit();
                    } catch (error) {
                        console.error('Error getting city:', error);
                        // Submit form without city if reverse geocoding fails
                        document.getElementById('latitude').value = latitude;
                        document.getElementById('longitude').value = longitude;
                        showLoading('Generating AI recommendations...');
                        e.target.submit();
                    }
                }, function(error) {
                    console.error('Error getting location:', error);
                    // Submit form without location if geolocation fails
                    showLoading('Generating AI recommendations...');
                    e.target.submit();
                });
            } else {
                console.log('Geolocation not supported');
                // Submit form without location if geolocation not supported
                showLoading('Generating AI recommendations...');
                e.target.submit();
            }
        } catch (error) {
            console.error('Error:', error);
            // Submit form without location in case of any other error
            showLoading('Generating AI recommendations...');
            e.target.submit();
        }
    });
</script>
{% endblock %}